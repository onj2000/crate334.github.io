<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIメディア判別システム（動画フレーム対応）</title>
    <!-- Tailwind CSS CDNをロード -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f9fc; 
        }
        .container-card {
            max-width: 700px;
            width: 100%;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading-animation {
            border-top-color: #ffffff;
            -webkit-animation: spinner 1s linear infinite;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 flex justify-center">

    <div class="container-card">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center mb-6">AIメディア判別システム</h1>
        <p class="text-center text-sm text-gray-600 mb-8">
            画像または動画ファイルをアップロードしてください。動画の場合は特定のフレームを画像として抽出し、分析を実行します。
        </p>

        <!-- モデル選択とAPIキー入力エリア -->
        <div class="space-y-4 mb-6">
            <label class="block text-base font-semibold text-gray-700">使用するモデルを選択：</label>
            <select id="modelSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                <option value="gemini">Google Gemini (AI生成画像鑑定)</option>
                <option value="huggingface">Hugging Face (画像分類)</option>
            </select>
        </div>

        <!-- Gemini API Field -->
        <div id="geminiKeyField" class="mb-6">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Gemini APIキー：
                <span class="text-blue-500 text-xs font-normal ml-2 cursor-pointer" onclick="showCustomModal('APIキー取得方法', document.getElementById('apiGuideText').innerHTML, 'text-blue-600')">
                    キーの取得方法はこちら
                </span>
            </label>
            <input id="geminiKey" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-inner" placeholder="AIzaSy...">
        </div>

        <!-- Hugging Face API Field -->
        <div id="hfKeyField" class="hidden mb-6">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Hugging Face Access Token：</label>
            <input id="hfKey" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-inner" placeholder="hf_xxxxxxxxxxxxxxx">
            <p class="text-xs text-gray-500 mt-1">※画像分類モデルの認証に使用されます。</p>
        </div>

        <!-- 画像/動画選択ドロップゾーン -->
        <div id="dropZone" class="p-6 border-2 border-dashed border-purple-400 rounded-xl text-center bg-purple-50 hover:bg-purple-100 transition duration-150 ease-in-out cursor-pointer">
            <svg class="w-8 h-8 mx-auto text-purple-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-1-5v-1a2 2 0 00-2-2H5a2 2 0 00-2 2v1m14 11h2a2 2 0 002-2v-3a2 2 0 00-2-2h-2M5 13H3a2 2 0 00-2 2v3a2 2 0 002 2h2m0-7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <p class="font-bold text-lg text-gray-700">画像/動画をドロップまたはクリックして選択</p>
            <input type="file" id="fileInput" accept="image/*,video/mp4,video/quicktime" class="hidden">
            <p id="fileName" class="text-gray-500 text-sm mt-1 truncate">ファイル未選択</p>
        </div>

        <!-- プレビュー -->
        <div id="preview" class="hidden my-6 p-4 flex justify-center bg-gray-50 rounded-lg border border-gray-200"></div>

        <!-- 分析ボタン -->
        <button id="analyzeBtn" disabled
            class="w-full py-3 px-4 bg-gray-400 text-white font-semibold rounded-lg shadow-md transition duration-200 ease-in-out disabled:opacity-50 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center">
            <span id="buttonText">APIキーとファイルを選択してください</span>
            <div id="loadingIndicator" class="hidden w-5 h-5 border-2 border-solid rounded-full loading-animation border-r-transparent ml-2"></div>
        </button>

        <!-- 結果表示エリア -->
        <div id="result" class="hidden mt-8 border-2 rounded-xl p-5 transition-all duration-300">
            <h2 class="text-xl font-bold mb-3 text-gray-800 border-b pb-2">判別結果</h2>
            <p id="resultText" class="text-2xl font-extrabold"></p>
            <p id="probability" class="text-sm text-gray-600 mt-1"></p>
            <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200 text-sm text-gray-700 leading-relaxed">
                <p class="font-semibold mb-1">モデルの根拠 / 分類ラベル:</p>
                <p id="reason"></p>
            </div>
        </div>

        <!-- 利用上の重要な注意事項セクション -->
        <div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded-md shadow-sm">
            <p class="font-bold flex items-center mb-2">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.427 2.607-1.427 3.372 0l4.344 8.1c.421.785-.121 1.701-.951 1.701H4.864c-.83 0-1.372-.916-.951-1.701l4.344-8.1zM11 16a1 1 0 10-2 0 1 1 0 002 0zm-1-6a1 1 0 00-1 1v2a1 1 0 102 0v-2a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                利用上の重要な注意事項 (費用と動画分析の制約)
            </p>
            <ul class="list-disc list-inside text-sm space-y-1">
                <li>**費用:** お客様ご自身のAPIキーを使用するため、無料利用枠を超過した場合、**利用者に費用が発生する**可能性があります。料金体系を必ずご確認ください。</li>
                <li>**動画分析の制約 (重要):** このアプリはGitHub Pages上で動作するため、動画ファイル全体を分析するのではなく、**動画の開始1秒時点のフレーム（単一の画像）を抽出**して分析しています。</li>
                <li>**長時間の動画分析:** 動画全体を分析するには、専用のバックエンドサービス（例: Google Cloud Storageと非同期処理）との連携が必要となり、現在のクライアントサイド構成では実現できません。</li>
            </ul>
        </div>
        
    </div>

    <!-- APIキー取得ガイドの非表示テキスト (モーダル用) -->
    <div id="apiGuideText" class="hidden">
        <p class="mb-3 font-semibold text-gray-800">APIキーの取得方法:</p>
        <ol class="list-decimal list-inside space-y-1 text-sm">
            <li>**Geminiキー:** <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>で「APIキーを作成」ボタンをクリックして取得します。</li>
            <li>**Hugging Faceトークン:** <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-blue-500 hover:underline">Hugging Faceの設定ページ</a>で「New token」を作成します。**権限はReadのみで十分です。**</li>
            <li>どちらのキーも、このアプリでは**保存されません**。</li>
        </ol>
    </div>

    <!-- カスタムモーダル (エラーメッセージ用) -->
    <div id="customModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50 transition duration-300">
        <div class="relative p-6 bg-white w-96 rounded-lg shadow-2xl transform scale-95 transition-transform">
            <h3 id="modalTitle" class="text-xl font-bold text-red-600 border-b pb-2 mb-3">エラーが発生しました</h3>
            <p id="modalMessage" class="text-gray-700 whitespace-pre-wrap"></p>
            <button onclick="document.getElementById('customModal').classList.add('hidden')" 
                    class="mt-6 w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow">閉じる</button>
        </div>
    </div>

    <script>
        // 定数
        const MODEL_GEMINI = "gemini-2.5-flash-preview-09-2025";
        const MODEL_HF = "google/vit-base-patch16-224"; // 汎用画像分類モデル
        
        // DOM要素
        const modelSelect = document.getElementById("modelSelect");
        const geminiKeyField = document.getElementById("geminiKeyField");
        const hfKeyField = document.getElementById("hfKeyField");
        const geminiKeyInput = document.getElementById("geminiKey");
        const hfKeyInput = document.getElementById("hfKey");
        const analyzeBtn = document.getElementById("analyzeBtn");
        const fileInput = document.getElementById("fileInput");
        const fileNameDisplay = document.getElementById("fileName");
        const previewContainer = document.getElementById("preview");
        const resultArea = document.getElementById("result");
        const buttonText = document.getElementById("buttonText");
        const loadingIndicator = document.getElementById("loadingIndicator");

        // グローバルデータ
        let base64Data = null;
        let mimeType = null;
        let originalFile = null; // オリジナルファイルオブジェクトを保持
        const RETRY_COUNT = 3;

        // --- ユーティリティ ---

        function showCustomModal(title, message, titleClass = 'text-red-600') {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalTitle').className = `text-xl font-bold border-b pb-2 mb-3 ${titleClass}`;
            document.getElementById('modalMessage').innerHTML = message;
            modal.classList.remove('hidden');
            modal.querySelector('.transform').classList.remove('scale-95');
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(",")[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function fetchWithBackoff(url, options) {
            // (fetchWithBackoff関数の内容は変更なし、省略)
            for (let i = 0; i < RETRY_COUNT; i++) {
                try {
                    const response = await fetch(url, options);

                    if (response.ok) {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.includes("application/json")) {
                            return await response.json();
                        }
                        return await response.json();
                    }

                    if (response.status === 429 && i < RETRY_COUNT - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    
                    let errorMessage = `APIエラー (${response.status} ${response.statusText})`;
                    try {
                        const errorData = await response.json();
                        errorMessage += `\n詳細: ${errorData.error?.message || errorData.error || errorData.detail || '不明なエラー'}`;
                    } catch {
                        errorMessage += `\n詳細: 応答ボディの解析に失敗しました。`;
                    }
                    throw new Error(errorMessage);

                } catch (error) {
                    if (i === RETRY_COUNT - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("APIリクエストが最大リトライ回数を超えて失敗しました。");
        }
        
        // --- 動画フレーム抽出ロジック ---
        
        function processVideoFrame(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.muted = true;
                video.preload = 'metadata';

                video.onloadedmetadata = function() {
                    if (video.duration < 1.0) {
                        // 1秒未満の短い動画の場合、開始フレームを使用
                        video.currentTime = 0;
                    } else {
                        // 1秒時点のフレームを抽出
                        video.currentTime = 1.0; 
                    }
                };

                video.onseeked = function() {
                    if (video.readyState > 2) {
                        // Canvasを作成
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        
                        // Canvasに現在のフレームを描画
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // PNGとしてBase64データを抽出
                        const frameData = canvas.toDataURL('image/png').split(",")[1];
                        
                        // プレビュー表示
                        previewContainer.innerHTML = `
                            <p class="text-sm text-gray-500 mb-2">動画から抽出されたフレーム (1秒時点):</p>
                            <img src="${canvas.toDataURL('image/png')}" class="max-h-64 h-auto rounded-lg shadow-lg object-contain">
                        `;
                        previewContainer.classList.remove("hidden");

                        resolve(frameData);
                    } else {
                        reject(new Error("動画のシークに失敗しました。ファイルが破損している可能性があります。"));
                    }
                };

                video.onerror = (e) => {
                    reject(new Error("動画ファイルの読み込み中にエラーが発生しました。"));
                };

                video.src = URL.createObjectURL(file);
                video.load();
            });
        }


        // --- UIイベントハンドラ ---
        
        modelSelect.addEventListener("change", () => {
            const val = modelSelect.value;
            geminiKeyField.classList.toggle("hidden", val !== "gemini");
            hfKeyField.classList.toggle("hidden", val !== "huggingface");
            updateButtonState();
        });

        [geminiKeyInput, hfKeyInput].forEach(input => input.addEventListener("input", updateButtonState));

        document.getElementById("dropZone").addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", async e => {
            resultArea.classList.add("hidden");
            const file = e.target.files[0];
            originalFile = file;

            if (!file) {
                fileNameDisplay.textContent = "ファイル未選択";
                previewContainer.classList.add("hidden");
                base64Data = null;
                updateButtonState();
                return;
            }

            fileNameDisplay.textContent = file.name;
            mimeType = file.type;

            try {
                if (file.type.startsWith('image/')) {
                    // 画像ファイルの場合
                    base64Data = await toBase64(file);
                    previewContainer.innerHTML = `<img src="${URL.createObjectURL(file)}" class="max-h-64 h-auto rounded-lg shadow-lg object-contain">`;
                    previewContainer.classList.remove("hidden");
                } else if (file.type.startsWith('video/')) {
                    // 動画ファイルの場合
                    fileNameDisplay.textContent += " (フレーム抽出中...)";
                    setLoadingState(true);
                    
                    // 動画フレームを抽出し、base64DataとmimeType（'image/png'）を更新
                    base64Data = await processVideoFrame(file);
                    mimeType = 'image/png'; // 抽出したフレームはPNG画像として扱う
                    
                    fileNameDisplay.textContent = file.name + " (1秒フレーム抽出完了)";
                } else {
                    throw new Error("非対応のファイル形式です。");
                }
            } catch (e) {
                showCustomModal("ファイルエラー", `ファイルの処理中にエラーが発生しました:\n${e.message}`, 'text-red-600');
                base64Data = null;
                fileNameDisplay.textContent = "ファイル未選択";
            } finally {
                setLoadingState(false, true); // ファイル処理完了後にローディングを解除
                updateButtonState();
            }
        });


        function updateButtonState() {
            const model = modelSelect.value;
            const geminiKeyValid = geminiKeyInput.value.trim().length > 20;
            const hfKeyValid = hfKeyInput.value.trim().startsWith("hf_");

            const keyValid = model === "gemini" ? geminiKeyValid : hfKeyValid;
            const isReady = keyValid && base64Data !== null;
            
            analyzeBtn.disabled = !isReady;

            if (isReady) {
                analyzeBtn.classList.replace("bg-gray-400", "bg-blue-500");
                buttonText.textContent = "分析開始";
            } else {
                analyzeBtn.classList.replace("bg-blue-500", "bg-gray-400");
                buttonText.textContent = "APIキーとファイルを選択してください";
            }
        }

        // ファイル処理中（isPreprocessing=true）とAPI処理中（isPreprocessing=false）でローディング表示を区別する
        function setLoadingState(isLoading, isPreprocessing = false) {
            analyzeBtn.disabled = isLoading;
            
            if (isLoading) {
                buttonText.textContent = isPreprocessing ? 'ファイルを処理中...' : '分析中...';
                analyzeBtn.classList.replace('bg-blue-500', 'bg-gray-500');
                analyzeBtn.classList.remove('hover:bg-blue-600');
            } else {
                 buttonText.textContent = '分析開始';
                 analyzeBtn.classList.replace('bg-gray-500', 'bg-blue-500');
                 analyzeBtn.classList.add('hover:bg-blue-600');
            }
            loadingIndicator.classList.toggle('hidden', !isLoading);
            updateButtonState(); // ボタンの状態を最終的に更新
        }

        // --- API呼び出しロジック ---

        async function analyzeGemini() {
            const key = geminiKeyInput.value.trim();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_GEMINI}:generateContent?key=${key}`;
            
            // 動画フレームであることを考慮したプロンプトに変更
            const fileType = originalFile.type.startsWith('video/') ? '動画の1秒時点のフレーム' : '画像';

            const systemPrompt = `あなたはAI生成画像の法医学アナリストです。AI生成によって生じる可能性のある視覚的な異常（不自然な指、テクスチャの繰り返し、矛盾した照明、ぼかし、特定のAIアーティファクト）がないかを確認してください。分析対象は${fileType}です。`;
            const userPrompt = "このファイルがAIで生成された可能性を0.0〜1.0で推定し、簡潔な根拠（200文字以内）を述べてください。JSON形式で返答してください。";
            
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "detectionResult": { "type": "STRING", "description": "AI生成の可能性が高い/低い" },
                    "probabilityScore": { "type": "NUMBER", "description": "AI生成の推定確率 (0.0〜1.0)" },
                    "justification": { "type": "STRING", "description": "簡潔な根拠 (200文字以内)" }
                },
                "propertyOrdering": ["detectionResult", "probabilityScore", "justification"]
            };
            
            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { 
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const res = await fetchWithBackoff(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const jsonText = res?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Geminiからの応答が不完全です。キーの有効性を確認してください。");
            
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                throw new Error("Geminiが期待されたJSON形式で応答しませんでした。再試行するか、プロンプトを見直してください。");
            }
        }

        async function analyzeHuggingFace() {
            const token = hfKeyInput.value.trim();
            const url = `https://api-inference.huggingface.co/models/${MODEL_HF}`;
            
            const binaryData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

            const res = await fetchWithBackoff(url, {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + token, 
                    "Content-Type": mimeType // 抽出されたフレームのMIME Typeは 'image/png'
                },
                body: binaryData,
            });

            if (!Array.isArray(res) || res.length === 0 || !res[0].label) {
                throw new Error("Hugging Faceモデルから有効な分類結果が得られませんでした。モデルIDが正しいか確認してください。");
            }

            const topResult = res[0];
            return {
                detectionResult: `Hugging Face (分類: ${topResult.label})`,
                probabilityScore: topResult.score,
                justification: `最も高い分類スコア: ${topResult.label} (${(topResult.score * 100).toFixed(2)}%)。このモデルはAI検出に特化していません。`
            };
        }

        analyzeBtn.addEventListener("click", async () => {
            const model = modelSelect.value;
            
            setLoadingState(true);

            try {
                const data = model === "gemini"
                    ? await analyzeGemini()
                    : await analyzeHuggingFace();
                displayResult(data, model);
            } catch (err) {
                console.error(err);
                showCustomModal("分析エラー", err.message, 'text-red-600');
            } finally {
                setLoadingState(false);
            }
        });

        // --- 結果表示 ---

        function displayResult(data, model) {
            const resultText = document.getElementById("resultText");
            const probability = document.getElementById("probability");
            const reason = document.getElementById("reason");

            resultArea.classList.remove("hidden");
            const score = parseFloat((data.probabilityScore * 100).toFixed(1));
            
            resultArea.classList.remove("border-red-400", "border-green-400", "border-gray-400");
            resultText.classList.remove('text-red-600', 'text-green-600');
            resultArea.style.backgroundColor = '';

            if (model === 'gemini') {
                if (score >= 60) {
                    resultArea.classList.add("border-red-400");
                    resultArea.style.backgroundColor = "#fef2f2";
                    resultText.classList.add('text-red-600');
                } else {
                    resultArea.classList.add("border-green-400");
                    resultArea.style.backgroundColor = "#f0fff4";
                    resultText.classList.add('text-green-600');
                }
            } else {
                 resultArea.classList.add("border-gray-400");
                 resultArea.style.backgroundColor = "#f7f9fc";
            }

            resultText.textContent = data.detectionResult || "結果不明";
            probability.textContent = `確信度/スコア: ${score}%`;
            reason.textContent = data.justification || "モデルは詳細な根拠を提供しませんでした。";
        }

        window.onload = () => {
            updateButtonState();
        };
    </script>
</body>
</html>

